<div class="container bg-light p-3 rounded-lg shadow">
  <div class="d-flex justify-content-between align-items-center">
    <h1>Quản lý bài viết</h1>
    {{!-- Writer được phép thêm bài viết --}}
    {{#if (eq authUser.role 'writer')}}
    <button class="btn btn-primary ml-2" onclick="window.location.href = '/admin/articles/create'">
      <i class="bi bi-plus-circle"></i> Thêm bài viết
    </button>
    {{/if}}
  </div>
</div>

<div class="container bg-light p-3 rounded-lg shadow my-4">
  <!-- Tabs -->
  <ul class="nav nav-tabs" id="articleTabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="draft-tab" data-toggle="tab" href="#draft" role="tab" aria-controls="draft"
        aria-selected="true">Chờ duyệt</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="approved-tab" data-toggle="tab" href="#approved" role="tab" aria-controls="approved"
        aria-selected="false">Đã duyệt</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="published-tab" data-toggle="tab" href="#published" role="tab" aria-controls="published"
        aria-selected="false">Xuất bản</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="rejected-tab" data-toggle="tab" href="#rejected" role="tab" aria-controls="rejected"
        aria-selected="false">Bị từ chối</a>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content" id="articleTabContent">
    <!-- Chờ duyệt -->
    <div class="tab-pane fade show active" id="draft" role="tabpanel" aria-labelledby="draft-tab">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Ảnh bìa</th>
            <th scope="col">Tiêu đề</th>
            <th scope="col">Nội dung</th>
            <th scope="col">Chuyên mục</th>
            <th scope="col">Hành động</th>
          </tr>
        </thead>
        <tbody>
          {{!-- Hiển thị bài viết chờ duyệt --}}
          {{#each draftArticles}}
          <tr data-id="{{id}}">
            <th scope="row">{{getNextPageIndex ../currentPage @index ../limit}}</th>
            <td><img src="{{thumbnail}}" height="auto" width="70" alt="Ảnh bìa"></td>
            <td>{{title}}</td>
            <td>{{abstract}}</td>
            <td>{{category}}</td>
            <td>
              {{#if (eq authUser.role 'writer')}}
              <button class="btn btn-primary btn-sm" onclick="window.location.href = '/admin/articles/edit?id={{id}}'">
                Sửa
              </button>
              {{/if}}
              {{!-- Admin có quyền sửa, xóa và xuất bản tất cả --}}
              {{#if (eq authUser.role 'admin')}}
              <button class="btn btn-primary btn-sm" onclick="window.location.href = '/admin/articles/edit?id={{id}}'">
                Sửa
              </button>
              <button class="btn btn-success btn-sm"
                onclick="window.location.href = '/admin/articles/publish?id={{id}}'">
                Xuất bản
              </button>
              <button class="btn btn-danger btn-sm" data-toggle="modal" data-target="#deleteArticleModal"
                data-id="{{id}}">
                Xóa
              </button>
              {{/if}}
              {{!-- Editor có quyền duyệt hoặc từ chối --}}
              {{#if (eq authUser.role 'editor')}}
              <button class="btn btn-success btn-sm"
                onclick="window.location.href = '/admin/articles/approve?id={{id}}'">
                Duyệt
              </button>
              <button class="btn btn-warning btn-sm"
                onclick="window.location.href = '/admin/articles/reject?id={{id}}'">
                Từ chối
              </button>
              {{/if}}
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
      <!-- Phân trang cho Chờ duyệt -->
      {{#if (gt totalDraftPages 1)}}
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          <!-- Nút Previous -->
          {{#if (gt currentPage 1)}}
          <li class="page-item">
            <a class="page-link" href="/admin/articles?page={{subtract currentPage 1}}&search={{searchTerm}}"
              aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {{else}}
          <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {{/if}}

          <!-- Hiển thị các trang -->
          {{#each draftPageItems}}
          <li class="page-item {{status}}">
            <a class="page-link" href="/admin/articles?page={{value}}&search={{searchTerm}}">{{value}}</a>
          </li>
          {{/each}}

          <!-- Nút Next -->
          {{#if (lt currentPage totalDraftPages)}}
          <li class="page-item">
            <a class="page-link" href="/admin/articles?page={{add currentPage 1}}&search={{searchTerm}}"
              aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          {{else}}
          <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          {{/if}}
        </ul>
      </nav>
      {{/if}}
    </div>

    <!-- Đã duyệt -->
    <div class="tab-pane fade" id="approved" role="tabpanel" aria-labelledby="approved-tab">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Ảnh bìa</th>
            <th scope="col">Tiêu đề</th>
            <th scope="col">Nội dung</th>
            <th scope="col">Chuyên mục</th>
            <th scope="col">&nbsp;</th>
          </tr>
        </thead>
        <tbody>
          {{!-- Hiển thị bài viết đã duyệt --}}
          {{#each approvedArticles}}
          <tr data-id="{{id}}">
            <th scope="row">{{getNextPageIndex ../currentPage @index ../limit}}</th>
            <td><img src="{{thumbnail}}" height="auto" width="70" alt="Ảnh bìa"></td>
            <td>{{title}}</td>
            <td>{{abstract}}</td>
            <td>{{category}}</td>
            <td>
              <div class="btn-group">
                {{!-- Admin có quyền sửa, xóa và xuất bản tất cả --}}
                {{#if (eq authUser.role 'admin')}}
                <button class="btn btn-primary btn-sm"
                  onclick="window.location.href = '/admin/articles/edit?id={{id}}'">
                  Sửa
                </button>
                <button class="btn btn-success btn-sm"
                  onclick="window.location.href = '/admin/articles/publish?id={{id}}'">
                  Xuất bản
                </button>
                <button class="btn btn-danger btn-sm" data-toggle="modal" data-target="#deleteArticleModal"
                  data-id="{{id}}">
                  Xóa
                </button>
                {{/if}}
              </div>
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
      <!-- Phân trang cho Đã duyệt -->
      {{#if (gt totalApprovedPages 1)}}
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          <!-- Nút Previous -->
          {{#if (gt currentPage 1)}}
          <li class="page-item">
            <a class="page-link" href="/admin/articles?page={{subtract currentPage 1}}&search={{searchTerm}}"
              aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {{else}}
          <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {{/if}}

          <!-- Hiển thị các trang -->
          {{#each approvedPageItems}}
          <li class="page-item {{status}}">
            <a class="page-link" href="/admin/articles?page={{value}}&search={{searchTerm}}">{{value}}</a>
          </li>
          {{/each}}

          <!-- Nút Next -->
          {{#if (lt currentPage totalApprovedPages)}}
          <li class="page-item">
            <a class="page-link" href="/admin/articles?page={{add currentPage 1}}&search={{searchTerm}}"
              aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          {{else}}
          <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          {{/if}}
        </ul>
      </nav>
      {{/if}}
    </div>

    <!-- Xuất bản -->
    <div class="tab-pane fade" id="published" role="tabpanel" aria-labelledby="published-tab">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Ảnh bìa</th>
            <th scope="col">Tiêu đề</th>
            <th scope="col">Nội dung</th>
            <th scope="col">Chuyên mục</th>
            <th scope="col">&nbsp;</th>
          </tr>
        </thead>
        <tbody>
          {{!-- Hiển thị bài viết đã xuất bản --}}
          {{#each publishedArticles}}
          <tr data-id="{{id}}">
            <th scope="row">{{getNextPageIndex ../currentPage @index ../limit}}</th>
            <td><img src="{{thumbnail}}" height="auto" width="70" alt="Ảnh bìa"></td>
            <td>{{title}}</td>
            <td>{{abstract}}</td>
            <td>{{category}}</td>
            <td>
              {{!-- Không cần nút hành động trong tab Xuất bản --}}
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
      <!-- Phân trang cho Xuất bản -->
      {{#if (gt totalPublishedPages 1)}}
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          <!-- Nút Previous -->
          {{#if (gt currentPage 1)}}
          <li class="page-item">
            <a class="page-link" href="/admin/articles?page={{subtract currentPage 1}}&search={{searchTerm}}"
              aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {{else}}
          <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {{/if}}

          <!-- Hiển thị các trang -->
          {{#each publishedPageItems}}
          <li class="page-item {{status}}">
            <a class="page-link" href="/admin/articles?page={{value}}&search={{searchTerm}}">{{value}}</a>
          </li>
          {{/each}}

          <!-- Nút Next -->
          {{#if (lt currentPage totalPublishedPages)}}
          <li class="page-item">
            <a class="page-link" href="/admin/articles?page={{add currentPage 1}}&search={{searchTerm}}"
              aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          {{else}}
          <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          {{/if}}
        </ul>
      </nav>
      {{/if}}
    </div>

    <!-- Bị từ chối -->
    <div class="tab-pane fade" id="rejected" role="tabpanel" aria-labelledby="rejected-tab">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Ảnh bìa</th>
            <th scope="col">Tiêu đề</th>
            <th scope="col">Nội dung</th>
            <th scope="col">Chuyên mục</th>
            <th scope="col">&nbsp;</th>
          </tr>
        </thead>
        <tbody>
          {{!-- Hiển thị bài viết bị từ chối --}}
          {{#each rejectedArticles}}
          <tr data-id="{{id}}">
            <th scope="row">{{getNextPageIndex ../currentPage @index ../limit}}</th>
            <td><img src="{{thumbnail}}" height="auto" width="70" alt="Ảnh bìa"></td>
            <td>{{title}}</td>
            <td>{{abstract}}</td>
            <td>{{category}}</td>
            <td>
              <div class="btn-group">
                {{!-- Writer chỉ sửa bài viết của họ --}}
                {{#if (and (eq authUser.role 'writer') (eq this.author_id authUser.id))}}
                <button class="btn btn-primary btn-sm"
                  onclick="window.location.href = '/admin/articles/edit?id={{id}}'">
                  Sửa
                </button>
                {{/if}}
                {{!-- Admin có quyền sửa và xóa tất cả --}}
                {{#if (eq authUser.role 'admin')}}
                <button class="btn btn-primary btn-sm"
                  onclick="window.location.href = '/admin/articles/edit?id={{id}}'">
                  Sửa
                </button>
                <button class="btn btn-danger btn-sm" data-toggle="modal" data-target="#deleteArticleModal"
                  data-id="{{id}}">
                  Xóa
                </button>
                {{/if}}
              </div>
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
      <!-- Phân trang cho Bị từ chối -->
      {{#if (gt totalRejectedPages 1)}}
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          <!-- Nút Previous -->
          {{#if (gt currentPage 1)}}
          <li class="page-item">
            <a class="page-link" href="/admin/articles?page={{subtract currentPage 1}}&search={{searchTerm}}"
              aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {{else}}
          <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {{/if}}

          <!-- Hiển thị các trang -->
          {{#each rejectedPageItems}}
          <li class="page-item {{status}}">
            <a class="page-link" href="/admin/articles?page={{value}}&search={{searchTerm}}">{{value}}</a>
          </li>
          {{/each}}

          <!-- Nút Next -->
          {{#if (lt currentPage totalRejectedPages)}}
          <li class="page-item">
            <a class="page-link" href="/admin/articles?page={{add currentPage 1}}&search={{searchTerm}}"
              aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          {{else}}
          <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          {{/if}}
        </ul>
      </nav>
      {{/if}}
    </div>
  </div>
</div>

<div class="modal fade" id="deleteArticleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="/admin/articles/delete" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Xóa bài viết</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="id" id="deleteId">
        <p>Bạn có chắc chắn muốn xóa bài viết?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
        <button type="submit" class="btn btn-primary">Xóa</button>
      </div>
    </form>
  </div>
</div>

<script>
  $(document).ready(function () {
    // Populate delete modal with article ID
    $('#deleteArticleModal').on('show.bs.modal', function (event) {
      var button = $(event.relatedTarget);
      var id = button.data('id');

      var modal = $(this);
      modal.find('#deleteId').val(id);
    });
  });
</script>